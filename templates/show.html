{% extends "base.html" %}
{% block title %}view product{% endblock %}
{% block content %}
<div class="container mt-4">
    <div class="row">
        <!-- Left Side: Listing Information -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header bg-transparent border-0 pb-2">
                    <div class="star-rating mb-2">
                        <i class="fas fa-star gold-star"></i>
                        <i class="fas fa-star gold-star"></i>
                        <i class="fas fa-star gold-star"></i>
                        <i class="fas fa-star gold-star"></i>
                        <i class="fas fa-star white-star"></i>
                    </div>
                    <h2 class="h4 text-primary fw-bold">{{ listing.title }}</h2>
                </div>
                <div class="card-body">
                    <div class="offer-stamp d-none position-absolute top-10 end-0" data-listing-id="{{ listing.id }}">
                        <img src="{{ url_for('static', filename='images/stamps.png') }}" alt="Special Offer">
                    </div>
                    <p class="text-muted"><i class="bi bi-tags"></i> <strong>Category:</strong> {{ listing.category }}</p>
                    <p class="text-muted"><i class="bi bi-file-text"></i> <strong>Description:</strong> {{ listing.description }}</p>

                    <p class="text-danger fw-bold bi bi-currency-exchange">
                        KES {{ "{:,.0f}".format(listing.price) }}
                    </p>
                    <p class="text-muted"><i class="bi bi-geo-alt"></i> <strong>Location:</strong> {{ listing.location }}</p>
                    <p class="text-muted"><i class="bi bi-box"></i> <strong>Condition:</strong> {{ listing.condition }}</p>
                    <p class="text-muted"><i class="bi bi-person"></i> <strong>Seller:</strong> {{ listing.seller }}</p>
                
                    <!-- WhatsApp Contact Link -->
                    <p class="text-muted">
                        <i class="bi bi-whatsapp text-success"></i> <strong>Phone:</strong> 
                        <a href="https://wa.me/{{ listing.phone }}?text=Hello,%20I'm%20interested%20in%20your%20listing:%20{{ listing.title }}%20at%20KES%20{{ listing.price }}" 
                           target="_blank" 
                           class="text-decoration-none text-success fw-bold">
                            {{ listing.phone }}
                        </a>
                    </p>
                
                    <div class="mt-3 d-flex gap-3">
                        <!-- Add to Cart Button -->
                        <button class="btn futuristic-btn add-to-cart" data-listing-id="{{ listing.id }}">
                            <i class="bi bi-cart-plus"></i> Add to Cart
                        </button>
                        
                    </div>
                </div>
                
                <!-- Toast Notification Container -->
                <div id="toast-container" class="position-fixed bottom-0 end-0 p-3"></div>
                
                <!-- JavaScript for Add to Cart -->
              
                
            </div>
        </div>
        

        <!-- Right Side: Image Display with Carousel -->
        <div class="col-md-6 text-center">
            {% set images = listing.images.split(',') if listing.images else ['default.png'] %}
            
            <!-- Carousel for Main Image -->
            <div id="imageCarousel{{ listing.id }}" class="carousel slide" data-bs-ride="carousel">
                <div class="carousel-inner">
                    {% for image in images %}
                        <div class="carousel-item {% if loop.first %}active{% endif %}">
                            <img id="mainImage" 
                                 src="{{ url_for('static', filename='uploads/' + image.strip()) }}" 
                                 class="d-block w-100 main-img" 
                                 alt="Listing Image"
                                 data-bs-toggle="modal" data-bs-target="#imageModal{{ listing.id }}">
                        </div>
                    {% endfor %}
                </div>

                <!-- Carousel Controls -->
                <button class="carousel-control-prev" type="button" data-bs-target="#imageCarousel{{ listing.id }}" data-bs-slide="prev">
                    <span class="carousel-control-prev-icon"></span>
                </button>
                <button class="carousel-control-next" type="button" data-bs-target="#imageCarousel{{ listing.id }}" data-bs-slide="next">
                    <span class="carousel-control-next-icon"></span>
                </button>
            </div>

            <!-- Thumbnails (Click to Change Main Image) -->
            <div class="thumbnail-container mt-3">
                {% for image in images %}
                    <img src="{{ url_for('static', filename='uploads/' + image.strip()) }}" 
                         class="thumb-img"
                         onclick="updateMainImage('{{ url_for('static', filename='uploads/' + image.strip()) }}')">
                {% endfor %}
            </div>
        </div>
    </div>

    <!-- Modal for Enlarged Image -->
    <!-- Modal for Enlarged Image -->
<div class="modal fade" id="imageModal{{ listing.id }}" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
        <div class="modal-content bg-transparent border-0">
            <div class="modal-body d-flex">
                <!-- Thumbnails on the Far Left -->
                <div class="d-flex flex-column thumbnails-container">
                    {% for image in images %}
                        <img src="{{ url_for('static', filename='uploads/' + image.strip()) }}" 
                             class="thumb-img mb-2"
                             onclick="updateMainImage('{{ url_for('static', filename='uploads/' + image.strip()) }}')">
                    {% endfor %}
                </div>

                <!-- Centered Main Image -->
                <div class="d-flex justify-content-center align-items-center flex-grow-1 main-image-container">
                    <img id="modalImage" class="modal-img">
                </div>
            </div>
        </div>
    </div>
</div>

<!-- CSS for Styling -->
<style>
    .offer-stamp {
        position: absolute;
        top: 230px; /* Just below the thumbs-up */
        right: 10px;
        left: 280px;
        color: white;
        width: 90px; /* Increased size for better visibility */
        height: 90px;
        display: flex;
        align-items: center;
        justify-content: center;
        transform: rotate(-10deg);
       
    }
    .futuristic-btn.add-to-cart {
        width: 150px;
        height: 20px;
        font-size: 10px;  /* Adjust text size if needed */
        padding: 0;       /* Remove extra padding */
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .card-header {
        background-color: transparent; /* Ensures no background color */
        border: none; /* Removes border */
        padding-bottom: 10px; /* Adjust spacing */
    }
    
    /* Responsive Adjustments */
    @media (max-width: 768px) {
        .card-header {
            padding-bottom: 5px; /* Reduce spacing for smaller screens */
        }
    }
    
    @media (max-width: 480px) {
        .card-header {
            padding-bottom: 2px; /* Further reduce spacing on very small screens */
        }
        
    }
    
    .thumbnails-container {
        margin-right: 20px; /* Default margin */
    }
    
    /* Main Image */
    .main-img {
        width: 100%;
        max-width: 500px;
        height:450px;
        object-fit: cover;
        cursor: pointer;
        border-radius: 10px;
    }
    
    /* Thumbnails */
    .thumbnail-container {
        display: flex;
        justify-content: center;
        gap: 8px;
        flex-wrap: wrap;
    }
    
    .thumb-img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border 0.3s, transform 0.2s;
        border-radius: 5px;
    }
    
    .thumb-img:hover, .thumb-img:active {
        border: 2px solid #007bff;
        transform: scale(1.1);
    }
    
    /* Modal Image */
    .modal-img {
        width: 100%;
        max-width: 600px;
        height: auto;
        object-fit: contain;
        border-radius: 10px;
    }
    
    /* Background blur effect */
    .modal-backdrop.show {
        backdrop-filter: blur(10px);
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .thumbnails-container {
            margin-right: 10px; /* Reduce margin on smaller screens */
        }
    
        .main-img {
            max-width: 350px; /* Make main image smaller */
            height: 350px;
        }
    
        .thumb-img {
            width: 50px; /* Reduce thumbnail size */
            height: 50px;
        }
    
        .modal-img {
            max-width: 450px; /* Smaller modal image */
        }
    }
    
    @media (max-width: 480px) {
        .thumbnails-container {
            margin-right: 5px;
        }
    
        .main-img {
            max-width: 250px;
        }
    
        .thumb-img {
            width: 400px;
            height: 400px;
        }
    .card{
        width: 40px;
        height: 4px;
    }
        .modal-img {
            max-width: 350px;
        }
    }
    
</style>
</div>
<script>
    function updateMainImage(imageSrc) {
        document.getElementById('modalImage').src = imageSrc;
    }
</script>

<!-- JavaScript to Change Main Image & Update Modal -->
<script>
    function updateMainImage(src) {
        document.getElementById("mainImage").src = src;
        document.getElementById("modalImage").src = src;
    }
    
</script>
<script>
    document.addEventListener("DOMContentLoaded", function () {
        document.querySelectorAll(".add-to-cart").forEach(button => {
            button.addEventListener("click", function () {
                let listingId = this.getAttribute("data-listing-id");
                addToCart(listingId, this);
            });
        });
    });

    function addToCart(listingId, button) {
        fetch("/add_to_cart", {
            method: "POST",
            headers: {
                "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `listing_id=${listingId}`,
        })
        .then(response => response.json())
        .then(data => {
            if (data.status === "success") {
                button.innerHTML = "✔ Added to Cart";
                button.classList.remove("btn-success");
                button.classList.add("btn-secondary");
                button.disabled = true;

                updateCartCounter();
                showToast(data.message, "success");
            } else {
                showToast(data.message, "error");
            }
        })
        .catch(error => console.error("Error adding to cart:", error));
    }

    function showToast(message, category) {
        let toastContainer = document.getElementById("toast-container");

        let toastHTML = `
            <div class="toast align-items-center text-white bg-${category === 'error' ? 'danger' : 'success'} border-0 show" role="alert">
                <div class="d-flex">
                    <div class="toast-body text-center">
                        <i class="fa-solid fa-shopping-cart small-icon"></i> Bizzy 🛒
                        <i class="fas fa-${category === 'error' ? 'exclamation-circle' : 'check-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            </div>
        `;

        toastContainer.innerHTML = toastHTML;
        let toastElement = toastContainer.querySelector(".toast");
        let toast = new bootstrap.Toast(toastElement);
        toast.show();
    }

    function updateCartCounter() {
        fetch("/cart_count")
        .then(response => response.json())
        .then(data => {
            let cartCounter = document.getElementById("cart-counter");
            if (cartCounter) {
                cartCounter.textContent = data.count;
                cartCounter.style.display = data.count > 0 ? "inline-block" : "none";
            }
        })
        .catch(error => console.error("Error updating cart counter:", error));
    }
</script>

{% endblock %}
